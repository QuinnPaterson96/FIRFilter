#include <stdio.h>
#include <stdint.h>
#include <string.h>
#include <time.h>

/* DEFINES */
#define COUNTOF(x)  (sizeof(x)/sizeof(x[0U]))

/* Private Variables */
static double coeffs[] =
{
    -0.0000760544, -0.0000599103, -0.0000723654, -0.0000764797, -0.0000685439, -0.0000460371, -0.0000084292, 0.0000422083, 0.0001009384,
    0.0001601695, 0.0002103982, 0.0002414589, 0.0002441530, 0.0002120393, 0.0001430974, 0.0000409463, -0.0000846758, -0.0002183876, -0.0003406807,
    -0.0004303969, -0.0004679071, -0.0004385704, -0.0003359394, -0.0001641365, 0.0000611238, 0.0003132398, 0.0005573006, 0.0007543900, 0.0008671666,
    0.0008659954, 0.0007347179, 0.0004750820, 0.0001089399, -0.0003224377, -0.0007621979, -0.0011446944, -0.0014045288, -0.0014867030, -0.0013564205,
    -0.0010069586, -0.0004641437, 0.0002136710, 0.0009406536, 0.0016133658, 0.0021244861, 0.0023787005, 0.0023085554, 0.0018878316, 0.0011401173,
    0.0001407470, -0.0009889027, -0.0020947035, -0.0030094351, -0.0035764974, -0.0036745111, -0.0032391872, -0.0022788965, -0.0008809654, 0.0007931741,
    0.0025243677, 0.0040623559, 0.0051596771, 0.0056085487, 0.0052755655, 0.0041288945, 0.0022532475, -0.0001507356, -0.0027840959, -0.0052832247,
    -0.0072662482, -0.0083866532, -0.0083871445, -0.0071460654, -0.0047090824, -0.0013002650, 0.0026909382, 0.0067472829, 0.0102829808, 0.0127185196,
    0.0135623393, 0.0124890238, 0.0094033177, 0.0044803295, -0.0018253140, -0.0088050856, -0.0155564535, -0.0210721541, -0.0243499090, -0.0245105497,
    -0.0209107721, -0.0132366614, -0.0015657727, 0.0136112057, 0.0314137055, 0.0506387541, 0.0698667100, 0.0875945934, 0.1023828225, 0.1129992732,
    0.1185445886, 0.1185445886, 0.1129992732, 0.1023828225, 0.0875945934, 0.0698667100, 0.0506387541, 0.0314137055, 0.0136112057, -0.0015657727,
    -0.0132366614, -0.0209107721, -0.0245105497, -0.0243499090, -0.0210721541, -0.0155564535, -0.0088050856, -0.0018253140, 0.0044803295, 0.0094033177,
    0.0124890238, 0.0135623393, 0.0127185196, 0.0102829808, 0.0067472829, 0.0026909382, -0.0013002650, -0.0047090824, -0.0071460654, -0.0083871445,
    -0.0083866532, -0.0072662482, -0.0052832247, -0.0027840959, -0.0001507356, 0.0022532475, 0.0041288945, 0.0052755655, 0.0056085487, 0.0051596771,
    0.0040623559, 0.0025243677, 0.0007931741, -0.0008809654, -0.0022788965, -0.0032391872, -0.0036745111, -0.0035764974, -0.0030094351, -0.0020947035,
    -0.0009889027, 0.0001407470, 0.0011401173, 0.0018878316, 0.0023085554, 0.0023787005, 0.0021244861, 0.0016133658, 0.0009406536, 0.0002136710,
    -0.0004641437, -0.0010069586, -0.0013564205, -0.0014867030, -0.0014045288, -0.0011446944, -0.0007621979, -0.0003224377, 0.0001089399, 0.0004750820,
    0.0007347179, 0.0008659954, 0.0008671666, 0.0007543900, 0.0005573006, 0.0003132398, 0.0000611238, -0.0001641365, -0.0003359394, -0.0004385704,
    -0.0004679071, -0.0004303969, -0.0003406807, -0.0002183876, -0.0000846758, 0.0000409463, 0.0001430974, 0.0002120393, 0.0002441530, 0.0002414589,
    0.0002103982, 0.0001601695, 0.0001009384, 0.0000422083, -0.0000084292, -0.0000460371, -0.0000685439, -0.0000764797, -0.0000723654, -0.0000599103,
    -0.0000760544
};

static double input1[] = {
    2.0000000000, 1.7600735107, 1.1180339887, 0.2787682579, -0.5000000000, -1.0000000000, -1.1180339887, -0.8968022467, -0.5000000000,
    -0.1420395219, 0.0000000000, -0.1420395219, -0.5000000000, -0.8968022467, -1.1180339887, -1.0000000000, -0.5000000000, 0.2787682579, 1.1180339887,
    1.7600735107, 2.0000000000, 1.7600735107, 1.1180339887, 0.2787682579, -0.5000000000, -1.0000000000, -1.1180339887, -0.8968022467, -0.5000000000,
    -0.1420395219, 0.0000000000, -0.1420395219, -0.5000000000, -0.8968022467, -1.1180339887, -1.0000000000, -0.5000000000, 0.2787682579, 1.1180339887,
    1.7600735107, 2.0000000000, 1.7600735107, 1.1180339887, 0.2787682579, -0.5000000000, -1.0000000000, -1.1180339887, -0.8968022467, -0.5000000000,
    -0.1420395219, 0.0000000000, -0.1420395219, -0.5000000000, -0.8968022467, -1.1180339887, -1.0000000000, -0.5000000000, 0.2787682579, 1.1180339887,
    1.7600735107, 2.0000000000, 1.7600735107, 1.1180339887, 0.2787682579, -0.5000000000, -1.0000000000, -1.1180339887, -0.8968022467, -0.5000000000,
    -0.1420395219, 0.0000000000, -0.1420395219, -0.5000000000, -0.8968022467, -1.1180339887, -1.0000000000, -0.5000000000, 0.2787682579, 1.1180339887,
    1.7600735107, 2.0000000000, 1.7600735107, 1.1180339887, 0.2787682579, -0.5000000000, -1.0000000000, -1.1180339887, -0.8968022467, -0.5000000000,
    -0.1420395219, 0.0000000000, -0.1420395219, -0.5000000000, -0.8968022467, -1.1180339887, -1.0000000000, -0.5000000000, 0.2787682579, 1.1180339887,
    1.7600735107, 2.0000000000, 1.7600735107, 1.1180339887, 0.2787682579, -0.5000000000, -1.0000000000, -1.1180339887, -0.8968022467, -0.5000000000,
    -0.1420395219, 0.0000000000, -0.1420395219, -0.5000000000, -0.8968022467, -1.1180339887, -1.0000000000, -0.5000000000, 0.2787682579, 1.1180339887,
    1.7600735107, 2.0000000000, 1.7600735107, 1.1180339887, 0.2787682579, -0.5000000000, -1.0000000000, -1.1180339887, -0.8968022467, -0.5000000000,
    -0.1420395219, 0.0000000000, -0.1420395219, -0.5000000000, -0.8968022467, -1.1180339887, -1.0000000000, -0.5000000000, 0.2787682579, 1.1180339887,
    1.7600735107, 2.0000000000, 1.7600735107, 1.1180339887, 0.2787682579, -0.5000000000, -1.0000000000, -1.1180339887, -0.8968022467, -0.5000000000,
    -0.1420395219, 0.0000000000, -0.1420395219, -0.5000000000, -0.8968022467, -1.1180339887, -1.0000000000, -0.5000000000, 0.2787682579, 1.1180339887,
    1.7600735107, 2.0000000000, 1.7600735107, 1.1180339887, 0.2787682579, -0.5000000000, -1.0000000000, -1.1180339887, -0.8968022467, -0.5000000000,
    -0.1420395219, 0.0000000000, -0.1420395219, -0.5000000000, -0.8968022467, -1.1180339887, -1.0000000000, -0.5000000000, 0.2787682579, 1.1180339887,
    1.7600735107, 2.0000000000, 1.7600735107, 1.1180339887, 0.2787682579, -0.5000000000, -1.0000000000, -1.1180339887, -0.8968022467, -0.5000000000,
    -0.1420395219, 0.0000000000, -0.1420395219, -0.5000000000, -0.8968022467, -1.1180339887, -1.0000000000, -0.5000000000, 0.2787682579, 1.1180339887,
    1.7600735107, 2.0000000000
};

/* Private Functions */
// the FIR filter function
void firFloat( double* restrict coeffs, const uint32_t filterLength,  double* restrict input, const uint32_t inputLength, double* restrict output, const uint32_t outputLength)
{
    // Ensure none of the pointer are NULL
    if((coeffs != NULL) && (input != NULL) && (output != NULL))
    {
        // Run multiply and accumulate for each index in filter output
        for (uint32_t n = 0U; (n < outputLength) && (n < (filterLength + inputLength - 1)); n++)
        {
            double acc = 0;

            // Convolution
            for (uint32_t k = 0U; k < filterLength; k++ )
            {
                // Ensure the array bounds aren't exceeded
                // Data outside the bounds of the input is considered zero. Therefore, we can just skip it
                // `((int32_t)n - k) >= 0` can be moved into the for loop condition section to improve performace. Once it is true, it is always true
                if(((n - k) < inputLength) && (((int32_t)n - k) >= 0))
                {
                    acc += input[n - k] * coeffs[k];
                }
            }

            output[n] = acc;
        }
    }
}


// void intToFloat( int16_t *input, double *output, int length )
// {
//     int i;
//     for ( i = 0; i < length; i++ ) {
//         output[i] = (double)input[i]/(double)32768;
//     }
// }

// void floatToInt( double *input, int16_t *output, int length )
// {
//     int i;
//     for ( i = 0; i < length; i++ ) {
//         output[i] = input[i]*32768;

//     }
// }


// number of samples to read per loop, should be set to maximize cache hits


int main( void )
{

    double floatOutput[COUNTOF(coeffs) + COUNTOF(input1) - 1];
    memset(floatOutput, 0, sizeof(floatOutput));

	clock_t start = clock();

    for(int k =0; k < 10000; k++)
    {
        // Run the FIR filter
        firFloat(coeffs, COUNTOF(coeffs), input1, COUNTOF(input1), floatOutput, COUNTOF(floatOutput));
    }

    clock_t end = clock();

    // print out samples
    for(uint32_t i = 0U; i < COUNTOF(floatOutput) ; ++i)
    {
        if((i % 10 == 0) && (i != 0))
        {
        	printf("\n");
        }
        printf("%15.10f,", floatOutput[i]);
    }

    double Num_Of_Clocks = end - start;
    printf("\n");
    printf("Number of Clocks: %2.3f\n", Num_Of_Clocks);

    // printf("All Done");

    return 0;
}
